---
layout: post
title: "WSL2 and remote debugging"
categories: nextcloud php-fpm xdebug vscode wsl2
output:
  html_document:
    highlight: pygments
published: true
comments: false
tags: [nextcloud, php-fpm, debug, dev env, vscode, wsl2, xdebug]    
---
How to setup PHP server (nextcloud) or python server or node js
on [WSL2](https://docs.microsoft.com/en-us/windows/wsl/wsl2-ux-changes#accessing-windows-applications-from-linux) inside Windows10 (Build 18980)
 with remote debugging on VS Code using Extensions.
 
 
 For ex: [PHP Debug 1.13.0 extension](https://github.com/felixfbecker/vscode-php-debug)  is the [XDebug](https://xdebug.org/) adapter inside VSCode


#Intro
##WSL2 

WSL is aimed to be a Linux (POSIX like runtime environment inside Windows10)
In WSL1 it is a redirection of OS calls to underlying OS
In WSL2 it is a Linux kernel , acting a VM inside hosting OS (W10)

##Xdebug and VSCode
Please refer to this post:
{% post_url 2019-05-28-nextcloud-php-Xdebug %}

#Dynamic IP for WSL2 - Windows10 network bridge
https://docs.microsoft.com/en-us/windows/wsl/wsl2-ux-changes#accessing-windows-applications-from-linux

to connect to the Windows hosted (inside VS Code) XDebug server , PHP server (php-fpm10) must contact the hosting windows. 
The IP is the nameserver inside /etc/resolv.conf

```
gui@SAGIS-09:~$ cat /etc/resolv.conf
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.20.0.1
```

By default with a untouched php.ini setup , the log contains:
```
[11583] Log closed at 2019-09-17 14:54:46
[11583] E: Could not connect to client. :-(
[11583] W: Creating socket for '0.0.0.0:9009', poll success, but error: Operation now in progress (29).
[11583] I: Connecting to configured address/port: 0.0.0.0:9009.
[11583] Log opened at 2019-09-17 14:54:46
```
solution is to configure php-fpm to get xdebug listening on bridge IP / windows side instead on localhost 
```{r, engine='bash', eval = FALSE}
gui@SAGIS-09:/$ sudo vi /etc/php/7.3/fpm/php.ini

... 
[xdebug]
zend_extension="/usr/lib/php/20180731/xdebug.so"
xdebug.remote_enable=1
xdebug.remote_autostart=1
xdebug.remote_handler=dbgp
xdebug.remote_port=9009
xdebug.remote_host=172.20.0.1
xdebug.remote_log = /var/log/xdebug.log
```

#Open firewall on windows 10 : Windows Defender and XDebug sockets

Xdebug could log this: 

```
[11682] Log closed at 2019-09-17 14:57:03
[11682] E: Time-out connecting to client (Waited: 200 ms). :-(
[11678] I: Connecting to configured address/port: 172.20.0.1:9009.
[11678] Log opened at 2019-09-17 14:57:01
```

It is possible due to Firewall blocking VS Code , Xdebug server.
So authorize program:  code.exe to listen into Private 



# Dev workstation side (VS Code on windows10)

Because WSL2 is boxed, XDebug inside VS Code must listen on 0.0.0.0 instead of default localhost.
https://docs.microsoft.com/en-us/windows/wsl/wsl2-ux-changes#other-networking-considerations
Open the configurations on DEBUG / PHP (the launch.json file)
```json
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Listen for XDebug",
            "type": "php",
            "request": "launch",
            "hostname": "0.0.0.0", 
            "port": 9009,
            // server -> local
            "pathMappings": 
            {
                "/var/www/html": "${workspaceRoot}/www",
//                "/app": "${workspaceRoot}/app",
                "/home/gui/nc": "${workspaceRoot}",
                "/apps": "${workspaceRoot}/apps",
                "/custom_apps": "${workspaceRoot}/custom_apps"                
            }
        },
        {
            "name": "Launch currently open script",
            "type": "php",
            "request": "launch",
            "program": "${file}",
            "cwd": "${fileDirname}",
            "hostname": "0.0.0.0", 
            "port": 9009
        }
    ]
}
```